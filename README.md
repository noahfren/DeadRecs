# DeadRecs

A command-line recommendation engine for Grateful Dead live performances, powered by a Graph Neural Network trained on community ratings from [Headyversion.com](https://headyversion.com).

Given shows or songs you already enjoy, DeadRecs recommends other performances you're likely to appreciate by finding structurally and qualitatively similar nodes in a learned embedding space.

## How It Works

DeadRecs operates as a four-stage pipeline:

```
Scraper  ──>  Graph Builder  ──>  GNN Training  ──>  Recommendations
```

1. **Scrape** — Collects ~375 songs and thousands of community-rated performances from Headyversion.com, including vote counts, descriptions, venues, dates, and archive.org links.

2. **Build Graph** — Constructs a heterogeneous knowledge graph with three node types (Show, Song, SongPerformance) and four edge types. Shows are connected to their nearest neighbors via IDF-weighted Jaccard similarity over setlists, so shows with rare songs in common are linked more strongly than shows sharing only ubiquitous tunes.

3. **Train** — Trains a heterogeneous GraphSAGE model via self-supervised link prediction. Performance descriptions are encoded into 384-dimensional vectors using `all-MiniLM-L6-v2` and fed as node features alongside numeric signals like vote counts and IDF weights. The result is a 128-dimensional embedding for every show, song, and performance in the dataset.

4. **Recommend** — Looks up embeddings for your input shows/songs, averages them into a query vector, and returns the nearest neighbors by cosine similarity.

### Graph Schema

```
[Song: Dark Star] <──OF_SONG── [Perf: Dark Star @ 1972-08-27, 135 votes]
                                        │
                                  HAS_PERFORMANCE
                                        │
                               [Show: 1972-08-27, Veneta OR]
                                        │
                                 SETLIST_NEIGHBOR (0.45)
                                        │
                               [Show: 1972-08-21, Berkeley CA]
```

- **Show** nodes represent concerts, keyed by date
- **Song** nodes represent songs in the catalog, weighted by IDF
- **SongPerformance** nodes link a song to a show with vote counts and descriptions
- **SETLIST_NEIGHBOR** edges connect shows with similar setlists
- **TRANSITIONED_TO** edges capture song pairings (e.g., China Cat Sunflower > I Know You Rider)

## Installation

Requires Python 3.10+.

```bash
git clone https://github.com/noahfren/DeadRecs.git
cd DeadRecs
pip install -e .
```

For development (includes pytest):

```bash
pip install -e ".[dev]"
```

## Usage

### Scrape performance data

```bash
deadrecs scrape [--delay 1.0]
```

Fetches songs and rated performances from Headyversion.com. Supports resuming — re-running skips already-scraped songs. The `--delay` flag controls seconds between requests (default: 1.0).

### Train the model

```bash
deadrecs train [--epochs 100] [--k-neighbors 10]
```

Builds the graph from scraped data, computes description embeddings, and trains the GNN. `--k-neighbors` controls how many setlist-neighbor edges each show gets.

### Get recommendations

```bash
deadrecs recommend --like "1977-05-08" --like "Dark Star" [--n 10] [--type both]
```

Pass one or more shows (by date) or songs (by name) with `--like`. Use `--type` to filter results to `shows`, `songs`, or `both`.

### Look up details

```bash
deadrecs info "1977-05-08"
deadrecs info "Dark Star"
```

Displays rated performances, vote counts, venues, and archive.org links for a given show or song.

### Global options

```bash
deadrecs --version       # Print version
deadrecs -v <command>    # Enable verbose logging
```

## Project Structure

```
deadrecs/
  __init__.py          # Package version
  cli.py               # Click CLI with scrape, train, recommend, info commands
  scraper.py           # Headyversion.com scraper with pagination and resume support
  utils.py             # Data path constants and directory management
data/
  raw/
    songs_index.json   # Catalog of ~375 songs
    songs/             # Per-song JSON files with performance data
  graph.pickle         # Serialized NetworkX graph (generated by train)
  model.pt             # Trained GNN weights (generated by train)
  embeddings.pt        # Node embeddings (generated by train)
docs/
  requirements.md      # Functional and non-functional requirements
  design.md            # Architecture, graph schema, GNN design
  implementation-plan.md
tests/
  test_cli.py
  test_scraper.py
  test_utils.py
  fixtures/            # Sample HTML for scraper tests
```

## Tech Stack

- [PyTorch](https://pytorch.org/) + [PyTorch Geometric](https://pyg.org/) — GNN training and heterogeneous graph support
- [sentence-transformers](https://www.sbert.net/) — Text embeddings for performance descriptions
- [NetworkX](https://networkx.org/) — Graph construction and serialization
- [BeautifulSoup4](https://www.crummy.com/software/BeautifulSoup/) — HTML parsing for the scraper
- [Click](https://click.palletsprojects.com/) — CLI framework

## Running Tests

```bash
pytest
```

## License

MIT
